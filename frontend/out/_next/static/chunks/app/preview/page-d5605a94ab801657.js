(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[517],{4322:(e,t,a)=>{Promise.resolve().then(a.bind(a,6723))},6723:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>u});var r=a(5155),s=a(2115),o=a(6046),l=a(1247);a(2252),a(9408),a(6970),a(6816);var i=a(5999),n=a(4864),c=a.n(n),d=a(7112),m=a(2734);let g=()=>{let e=(0,o.useRouter)(),t=(e,t)=>JSON.stringify(e)===JSON.stringify(t),a=(0,s.useRef)(Date.now()+1e4),[n,g]=(0,s.useState)(null),[u,h]=(0,s.useState)(""),[x,p]=(0,s.useState)(""),[f,w]=(0,s.useState)(!0),[b,v]=(0,s.useState)(null),[y,j]=(0,s.useState)([]),[_,N]=(0,s.useState)([0,0,0]),[k,S]=(0,s.useState)(!1),[E,C]=(0,s.useState)(!1),P=(0,o.useSearchParams)(),[R,I]=(0,s.useState)("true"===P.get("paid")),[U,T]=(0,s.useState)("true"===P.get("approved")),[O,A]=(0,s.useState)(null),[F,L]=(0,s.useState)({}),[J,q]=(0,s.useState)("story1"),[B,D]=(0,s.useState)(null),[M,z]=(0,s.useState)(!1),[W,G]=(0,s.useState)([]),[V,H]=(0,s.useState)([]),[K,Y]=(0,s.useState)(null),[Q,X]=(0,s.useState)(0),[Z,$]=(0,s.useState)(0),[ee,et]=(0,s.useState)(!1),ea=(0,s.useRef)(null),[er,es]=(0,s.useState)("story");(0,s.useEffect)(()=>{let e=null;return e=setInterval(()=>{Z<100?$(e=>e+1):(clearInterval(e),et(!0))},900),()=>{e&&clearInterval(e)}},[Z]),(0,s.useEffect)(()=>{(async()=>{try{var e,t;let a=new URLSearchParams(window.location.search),r=a.get("job_id"),s=(null===(e=a.get("name"))||void 0===e?void 0:e.trim())||"",o=(null===(t=a.get("gender"))||void 0===t?void 0:t.trim())||"",l=a.get("job_type")||"story",i=a.get("book_id")||"story1",n=a.get("selected");if(!r||!s||!o)throw Error("Invalid request. Missing required parameters.");g(r),h(s),p(o),es(l),q(i),D(n||null)}catch(e){console.error("Error initializing preview:",e.message),v(e.message)}})()},[]),(0,s.useEffect)(()=>{n&&(async()=>{try{let t=await fetch("https://diffrun.com/get-job-status/".concat(n));if(!t.ok)throw Error("Failed to fetch job status.");let a=await t.json(),r=a.paid||!1,s=a.approved||!1;if(R!==r||U!==s){let t=new URLSearchParams(window.location.search);t.set("paid",r.toString()),t.set("approved",s.toString()),e.replace("/preview?".concat(t.toString()),{scroll:!1})}S(r),C(s),Y(a.workflow_status)}catch(e){console.error("Error fetching job status:",e.message),v(e.message||"An error occurred while fetching job status.")}})()},[n,R,U,e]),(0,s.useEffect)(()=>{if(!n||"completed"===K)return;let e=setInterval(async()=>{try{let t=await fetch("https://diffrun.com/get-job-status/".concat(n));if(t.ok){let a=await t.json();"completed"===a.workflow_status&&(Y("completed"),clearInterval(e))}}catch(e){console.warn("Workflow status check failed:",e)}},2e3);return()=>clearInterval(e)},[n,K]),(0,s.useEffect)(()=>{let e=document.getElementById("carousel-".concat(Q-1));e&&e.scrollIntoView({behavior:"smooth",block:"start"})},[Q]);let eo=async()=>{try{var e;console.log("\uD83D\uDCCA Polling images for job ID:",n);let r=await fetch("https://diffrun.com/poll-images?job_id=".concat(n,"&t=").concat(Date.now()));if(!r.ok)throw Error("Failed to fetch images.");let s=await r.json();if(console.log("\uD83D\uDDBC️ New images received:",s),j(e=>{let a=new Map;e.forEach(e=>{a.set(e.workflow,e.images.filter(e=>"object"==typeof e?e.url:e))}),(s.carousels||[]).forEach(e=>{let t=e.workflow,r=(a.get(t)||[]).filter(e=>"string"==typeof e&&!e.startsWith("loading-placeholder")||"object"==typeof e&&null!==e&&"filename"in e),s=new Set(r.filter(e=>"object"==typeof e&&"filename"in e).map(e=>e.filename)),o=e.images.filter(e=>!s.has(e.filename)),l=[...r,...o];a.set(t,l),o.length>=(F[t]||0)&&L(e=>{let a={...e};return delete a[t],a})});let r=Array.from(a.entries()).map(e=>{let[t,a]=e;return{workflow:t,images:a}}),o=r.filter(e=>e.images.length>0&&(1!==e.images.length||"loading-placeholder"!==e.images[0])).length;if(X(e=>Math.max(e,o)),V.length>0&&W.length===y.length){let e=V.filter(e=>{let t=y[e].workflow,a=r.find(e=>e.workflow===t);return((null==a?void 0:a.images.length)||0)>W[e]});e.length>0&&(H(t=>t.filter(t=>!e.includes(t))),G(t=>{let a=[...t];return e.forEach(e=>{let s=y[e].workflow,o=r.find(e=>e.workflow===s);a[e]=(null==o?void 0:o.images.length)||t[e]}),a}))}return t(e,r)?e:r}),M&&(null===(e=s.carousels)||void 0===e?void 0:e.length)>0){let e=s.carousels.map((e,t)=>{let a=_[t]||0;return Math.min(a,e.images.length-1)});N(e)}V.length>0||(Date.now(),a.current);let o=Object.values(F).some(e=>e>0);ea.current=setTimeout(eo,2e3),s.completed&&!o&&0===V.length&&setTimeout(()=>{w(!1)},1e3)}catch(e){console.error("⚠️ Error during image polling:",e.message),v("An error occurred while fetching images."),w(!1)}};(0,s.useEffect)(()=>{if(n)return ea.current=setTimeout(eo,2e3),()=>{ea.current&&clearTimeout(ea.current)}},[n]),(0,s.useEffect)(()=>{if(B&&0!==y.length)try{let e=c().decompressFromEncodedURIComponent(B),t=JSON.parse(e);Array.isArray(t)&&t.length===y.length&&(N(t),z(!0))}catch(e){console.warn("Failed to decompress selected slides:",e)}},[B,y.length]);let el=(e,t)=>{N(a=>{let r=[...a];return r[e]=t,r})};(0,s.useEffect)(()=>{if(!n||!y.length)return;let t=new URLSearchParams(window.location.search);t.set("selected",c().compressToEncodedURIComponent(JSON.stringify(_)));let a=t.toString();e.replace("/preview?".concat(a),{scroll:!1})},[_]);let ei=()=>{try{var t,a,r;if(!n||!u||!x||!er){console.error("Missing required parameters for redirection.");return}let s=null===(a=y[0])||void 0===a?void 0:null===(t=a.images)||void 0===t?void 0:t[_[0]],o="string"==typeof s?s:(null==s?void 0:null===(r=s.url)||void 0===r?void 0:r.startsWith("data:"))?"https://diffrun.com/preview?job_id=".concat(n,"&job_type=").concat(er,"&name=").concat(u,"&gender=").concat(x,"&book_id=").concat(J):(null==s?void 0:s.url)||"",l="comic"===er?"/comic1":"/user-details",i=new URLSearchParams({job_id:n,name:u,gender:x,preview_url:o,job_type:er,book_id:J,selected:c().compressToEncodedURIComponent(JSON.stringify(_))});e.push("".concat(l,"?").concat(i.toString()))}catch(e){console.error("\uD83D\uDEA8 Error during submission:",e.message)}},en=async()=>{try{if(!n)throw Error("Job ID is missing.");if(_.length!==y.length){console.warn("Mismatch between selected slides and workflows. Adjusting..."),N(Array(y.length).fill(0));return}if(!(await fetch("https://diffrun.com/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:n,selectedSlides:_})})).ok)throw Error("Failed to approve.");let e=c().compressToEncodedURIComponent(JSON.stringify(_)),t=new URLSearchParams({job_id:n,paid:String(k),approved:"true",selected:e,job_type:er,book_id:J,name:u,gender:x});window.location.href="/preview?".concat(t.toString())}catch(e){console.error("Error approving:",e.message)}},ec=()=>{ea.current&&clearTimeout(ea.current),ea.current=setTimeout(eo,2e3)};(0,s.useEffect)(()=>{y.length&&0===W.length&&G(y.map(e=>e.images.length))},[y]);let ed=async e=>{if(n)try{console.log("\uD83D\uDD04 Regenerating workflow",e+1),a.current=Date.now()+6e4;let t=(e+1).toString().padStart(2,"0");H(t=>[...t,e]),G(t=>{let a=[...t];return a[e]=y[e].images.length,a}),j(t=>t.map((t,a)=>a===e?{...t,images:[...t.images,"loading-placeholder"]}:t)),L(e=>({...e,[t]:1})),A(e);let r=await fetch("https://diffrun.com/regenerate-workflow",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({job_id:n,name:u,gender:x,workflow_number:y[e].workflow,jobType:er,book_id:J,force:"true"}).toString()});if(!r.ok)throw Error("Regeneration failed");await r.json(),ec(),console.log("Backend response: Regeneration triggered.")}catch(t){console.error("\uD83D\uDD25 Error during regeneration:",t),H(t=>t.filter(t=>t!==e))}};return(0,r.jsx)(s.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading..."}),children:(0,r.jsx)("div",{className:"min-h-screen bg-gray-100 p-4 sm:p-8",children:ee?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("header",{className:"max-w-4xl mx-auto mb-12 text-center",children:[(0,r.jsx)(d.P.h1,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.6,ease:"easeOut"},className:"text-2xl sm:text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-[#ff0202] to-[#c838cf] drop-shadow-[0_2px_4px_rgba(0,0,0,0.2)]",children:E?"".concat(u.charAt(0).toUpperCase()+u.slice(1),"'s Finalized Book"):k?"Finalize ".concat(u.charAt(0).toUpperCase()+u.slice(1),"'s Book"):"comic"===er?"Your Comic Preview":"".concat(u.charAt(0).toUpperCase()+u.slice(1),"'s Book Preview")}),(0,r.jsx)(d.P.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2,duration:.5},className:"text-lg sm:text-xl font-medium text-[#454545] inline-block",children:f?"comic"===er?"Assembling comic panels...":"Creating storybook magic...":b||("comic"===er?"Comic is ready!":"Storybook is ready!")}),(0,r.jsxs)(d.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4,duration:.5},className:"mt-10 text-base sm:text-lg text-gray-600 space-y-1 flex flex-col items-center",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(m.MTf,{size:20,className:"text-indigo-600"}),(0,r.jsx)("p",{children:"Pages get shown one below the other"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(m.sJ2,{size:20,className:"text-indigo-600"}),(0,r.jsx)("p",{children:"Swipe and leave each page at the option you like best"})]})]})]}),(0,r.jsx)("div",{className:"flex-1 w-full my-4 overflow-y-auto",children:(0,r.jsxs)("div",{className:"max-w-md w-full mx-auto space-y-12",children:[y.slice(0,Q).map((e,t)=>(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto mb-12 relative",children:[(0,r.jsx)("div",{className:"w-full text-center mb-2 flex justify-end",children:(0,r.jsxs)("div",{className:"inline-block px-3 py-1 text-sm font-medium text-gray-800 bg-gray-100 rounded-full",children:["Page ",t+1]})}),(0,r.jsxs)("div",{className:"relative w-full aspect-square overflow-hidden shadow-[5px_5px_10px_rgba(0,0,0,0.5)] bg-white",children:[0===e.images.length||1===e.images.length&&"loading-placeholder"===e.images[0]?(0,r.jsxs)("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500 mb-4"}),(0,r.jsxs)("p",{className:"text-sm text-gray-700 mt-4",children:["Generating image ",t+1," of ",y.length]})]}):(0,r.jsxs)(l.RC,{modules:[i.Vx,i.dK,i._R],slidesPerView:1,effect:"fade",fadeEffect:{crossFade:!0},navigation:{nextEl:".next-".concat(t),prevEl:".prev-".concat(t)},pagination:{clickable:!0},initialSlide:_[t]||0,onSlideChange:e=>el(t,e.activeIndex),className:"w-full h-full pb-8",children:[e.images.map((e,t)=>(0,r.jsx)(l.qr,{children:"loading-placeholder"===e?(0,r.jsx)("div",{className:"flex justify-center items-center w-full h-full bg-white",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-indigo-500"})}):(0,r.jsx)("img",{src:"string"==typeof e?e:e.url,alt:"Story Page ".concat(t+1),className:"w-full h-full object-cover"})},t)),!E&&(0,r.jsx)(l.qr,{children:(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center w-full h-full bg-white p-8 border-4 border-gray-900 shadow-[6px_6px_0px_rgba(0,0,0,0.8)]",children:[(0,r.jsx)("h2",{className:"text-2xl sm:text-3xl font-semibold text-gray-900 mb-6",children:"Generate More Options"}),(0,r.jsx)("button",{onClick:()=>ed(t),disabled:O===t,className:"px-6 py-3 text-lg font-bold rounded-md transition-all duration-200 \n                        ".concat(O===t?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-yellow-400 text-black hover:bg-yellow-500 active:bg-yellow-600 hover:shadow-[4px_4px_0px_rgba(0,0,0,0.8)] active:translate-x-[2px] active:translate-y-[2px]"),"aria-label":"Regenerate more options",children:O===t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("svg",{className:"animate-spin h-6 w-6 text-black inline-block mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),(0,r.jsx)("span",{children:"Regenerating..."})]}):"Regenerate"})]})},"generate-more")]},"".concat(t,"-").concat(_[t]||0)),0===e.images.length||1===e.images.length&&"loading-placeholder"===e.images[0]?(0,r.jsxs)("p",{className:"text-center text-sm text-gray-500 mt-8 italic",children:["Waiting for page ",t+1," to be generated..."]}):null]})]},t)),y.length>Q&&(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto mb-12 relative",children:[(0,r.jsx)("div",{className:"w-full text-center mb-2 flex justify-end",children:(0,r.jsxs)("div",{className:"inline-block px-3 py-1 text-sm font-medium text-gray-800 bg-gray-100 rounded-full",children:["Page ",Q+1]})}),(0,r.jsx)("div",{className:"relative w-full aspect-square overflow-hidden shadow-[5px_5px_10px_rgba(0,0,0,0.5)] bg-white",children:(0,r.jsxs)("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500 mb-4"}),(0,r.jsxs)("p",{className:"text-sm text-gray-700 mt-4",children:["Generating image ",Q+1," of ",y.length]})]})}),(0,r.jsxs)("p",{className:"text-center text-sm text-gray-500 mt-8 italic",children:["Waiting for page ",Q+1," to be generated..."]})]},"placeholder")]})}),"completed"!==K&&(0,r.jsxs)("div",{className:"fixed z-50 bottom-8 left-1/2 transform -translate-x-1/2 bg-white border-2 border-gray-800 p-6 rounded-lg shadow-brutalist text-center",style:{boxShadow:"8px 8px 0px rgba(0, 0, 0, 0.1)"},children:[(0,r.jsx)("p",{className:"text-gray-800 font-medium mb-4 text-lg sm:text-xl animate-fade-in",children:"Don't want to wait?"}),(0,r.jsx)("button",{onClick:()=>{let t=new URLSearchParams({job_id:n||"",name:u,gender:x,job_type:er,book_id:J,selected:c().compressToEncodedURIComponent(JSON.stringify(_))});e.push("/email-preview-request?".concat(t.toString()))},className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white py-2.5 px-5 font-medium border border-gray-900 shadow-[3px_3px_0px_rgba(0,0,0,0.9)] transition-transform duration-300 hover:-translate-y-1 hover:shadow-[5px_5px_0px_rgba(0,0,0,1)] focus:outline-none focus:ring-2 focus:ring-gray-900",children:"Email me the Preview Link"})]}),(0,r.jsx)("footer",{className:"w-full p-4 sm:p-6",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto flex flex-col sm:flex-row gap-2 sm:gap-4 justify-center",children:["comic"!==er&&!k&&!E&&(0,r.jsx)("button",{onClick:ei,disabled:!n||f||y.length<2,className:"px-6 py-3 rounded-[1rem] text-sm sm:text-base font-medium text-white\n                ".concat(y.length>=2?"bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 shadow-[3px_3px_0px_#232323]":"bg-gray-300 cursor-not-allowed"),children:"Save Preview & Show Price"}),"comic"!==er&&k&&!E&&(0,r.jsx)("button",{onClick:en,disabled:!n||f||y.length<2,className:"px-6 py-3 rounded-[1rem] text-sm sm:text-base font-medium text-white\n                ".concat(y.length>=2?"bg-[#4ECDC4] hover:bg-[#40baba] active:bg-[#33aaaa] shadow-[3px_3px_0px_#454545]":"bg-gray-300 cursor-not-allowed"),children:"Approve"}),"comic"===er&&(0,r.jsx)("button",{onClick:ei,className:"px-6 py-3 rounded-[1rem] text-sm sm:text-base font-medium text-white   bg-[#454545] hover:bg-[#333] active:bg-[#1a1a1a] shadow-[3px_3px_0px_#FF6B6B]",children:"Create Comic"})]})})]}):(0,r.jsxs)("div",{className:"max-w-4xl mx-auto text-center px-4 py-10",children:[(0,r.jsxs)("h1",{className:"text-2xl sm:text-4xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-[#ff0202] to-[#c838cf] drop-shadow-[0_2px_4px_rgba(0,0,0,0.2)]",children:[u.charAt(0).toUpperCase()+u.slice(1),"'s Book Preview"]}),(0,r.jsx)("p",{className:"text-lg sm:text-xl font-medium text-[#454545] inline-block mt-2",children:"Creating storybook magic..."}),(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center space-y-3 mt-10",children:[(0,r.jsx)(e=>{let{progress:t}=e;return(0,r.jsx)("div",{className:"w-full sm:w-2/3 h-3 bg-gray-300 rounded-full overflow-hidden",children:(0,r.jsx)("div",{className:"h-full bg-green-500 transition-all duration-300",style:{width:"".concat(t,"%")}})})},{progress:Z}),(0,r.jsxs)("p",{className:"text-sm text-black font-bold tracking-wide",children:["Progress: ",Z,"%"]})]}),(0,r.jsx)("div",{className:"mt-8 italic",children:(0,r.jsx)("p",{children:"Good things take a few seconds... Great images take a little longer!"})}),(0,r.jsxs)("div",{className:"text-base mt-14 font-mono text-black",children:[(0,r.jsx)("p",{children:"Don't want to wait?"}),(0,r.jsx)("div",{className:"mt-4",children:(0,r.jsx)("button",{onClick:()=>{let t=new URLSearchParams({job_id:n||"",name:u,gender:x,job_type:er,book_id:J,selected:c().compressToEncodedURIComponent(JSON.stringify(_))});e.push("/email-preview-request?".concat(t.toString()))},className:"bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white py-2.5 px-5 font-medium border border-gray-900 shadow-[3px_3px_0px_rgba(0,0,0,0.9)] transition-transform duration-300 hover:-translate-y-1 hover:shadow-[5px_5px_0px_rgba(0,0,0,1)] focus:outline-none focus:ring-2 focus:ring-gray-900",children:"Email me the Preview Link"})})]})]})})})};function u(){return(0,r.jsx)(s.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading..."}),children:(0,r.jsx)(g,{})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[315,87,112,707,441,587,358],()=>t(4322)),_N_E=e.O()}]);